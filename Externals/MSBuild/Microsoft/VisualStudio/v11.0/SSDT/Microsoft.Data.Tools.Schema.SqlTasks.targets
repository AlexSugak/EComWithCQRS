<?xml version="1.0" encoding="utf-8"?>

<!--
  Microsoft.Data.Tools.Schema.SqlTasks.targets.targets

  WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
            created a backup copy.  Incorrect changes to this file will make it
            impossible to load or build your projects from the command-line or the IDE.

  Copyright (C) Microsoft Corporation. All rights reserved.
  -->

<Project InitialTargets="CheckRequiredProperties" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <VisualStudioVersion Condition="'$(VisualStudioVersion)' == ''">10.0</VisualStudioVersion>
    <SqlServerRedistPath Condition="'$(SqlServerRedistPath)' == ''">$(MSBuildProgramFiles32)\Microsoft SQL Server\110\DAC\Bin</SqlServerRedistPath>
  </PropertyGroup>
  
  <!--Calculation of the VS install path-->
  <PropertyGroup>
    <DacPacRootPath Condition="'$(VisualStudioVersion)' == '10.0' AND '$(DacPacRootPath)' == ''">$(VS100COMNTOOLS)..\..\</DacPacRootPath>
    <DacPacRootPath Condition="'$(VisualStudioVersion)' == '11.0' AND '$(DacPacRootPath)' == ''">$(VS110COMNTOOLS)..\..\</DacPacRootPath>
  </PropertyGroup>
   <!--
   Task declarations
   -->
  <UsingTask TaskName="SqlBuildTask" AssemblyFile="$(SqlServerRedistPath)\Microsoft.Data.Tools.Schema.Tasks.Sql.11.dll" />
  <UsingTask TaskName="SqlDeployTask" AssemblyFile="$(SqlServerRedistPath)\Microsoft.Data.Tools.Schema.Tasks.Sql.11.dll" />
  <UsingTask TaskName="SqlModelResolutionTask" AssemblyFile="$(SqlServerRedistPath)\Microsoft.Data.Tools.Schema.Tasks.Sql.11.dll" />
  <UsingTask TaskName="SqlPublishTask" AssemblyFile="$(SqlServerRedistPath)\Microsoft.Data.Tools.Schema.Tasks.Sql.11.dll" />
  <UsingTask TaskName="SqlScriptDependenciesTask" AssemblyFile="$(SqlServerRedistPath)\Microsoft.Data.Tools.Schema.Tasks.Sql.11.dll" />
  <UsingTask TaskName="SqlStaticCodeAnalysisTask" AssemblyFile="$(SqlServerRedistPath)\Microsoft.Data.Tools.Schema.Tasks.Sql.11.dll" />

  <!--
   This targets overrides the default behavior in the commons target. This will make the IDE to not automatically run the csc/vb compile task 
   even when the inputs and outputs are not out of date. This allows incremental build for C# and VB code.
   -->
  <Target Name="_ComputeNonExistentFileProperty" />

  <!--
   Properties that must be set in the main project file (before using this .TARGETS file) can
   be checked here.  This is also set as the initial target.
   -->
  <Target Name="CheckRequiredProperties" />

  <!--
   Define properties that must be set before importing .Net .targets.
   -->
  <PropertyGroup>
    <AddAdditionalExplicitAssemblyReferences>false</AddAdditionalExplicitAssemblyReferences>
    <OutputType>Library</OutputType>
    <TargetExt>.dll</TargetExt>
    <TargetLanguage Condition="'$(TargetLanguage)' == ''">CS</TargetLanguage>
    <DefineConstants Condition=" '$(TargetLanguage)' == 'CS' And '$(DefineTrace)' == 'true' And '$(DefineConstants)' != ''">TRACE;$(DefineConstants)</DefineConstants>
    <DefineConstants Condition=" '$(TargetLanguage)' == 'CS' And '$(DefineTrace)' == 'true' And '$(DefineConstants)' == ''">TRACE</DefineConstants>
    <DefineConstants Condition=" '$(TargetLanguage)' == 'CS' And '$(DefineDebug)' == 'true' And '$(DefineConstants)' != ''">DEBUG;$(DefineConstants)</DefineConstants>
    <DefineConstants Condition=" '$(TargetLanguage)' == 'CS' And '$(DefineDebug)' == 'true' And '$(DefineConstants)' == ''">DEBUG</DefineConstants>
  </PropertyGroup>

  <!--
   Import the appropriate targets file based on language.
   -->
  <Import Condition="'$(TargetLanguage)' == 'CS'" Project="$(MSBuildBinPath)\Microsoft.CSharp.targets" />
  <Import Condition="'$(TargetLanguage)' == 'VB'" Project="$(MSBuildBinPath)\Microsoft.VisualBasic.targets" />
  
  <PropertyGroup>
    <SsdtTargetsParentPath>$(MSBuildExtensionsPath)\Microsoft\VisualStudio\v$(VisualStudioVersion)\SSDT</SsdtTargetsParentPath>
  </PropertyGroup>
  
  <!--
  Conditional import of powertools targets file
  -->
  <Import Project="$(SsdtTargetsParentPath)\Microsoft.Data.Tools.Schema.SqlPowerTools.targets" 
          Condition="Exists('$(SsdtTargetsParentPath)\Microsoft.Data.Tools.Schema.SqlPowerTools.targets')"/>

  <!--
   This makes the project files a dependency of all targets so that a rebuild occurs if they change
   -->
  <PropertyGroup>
    <MSBuildAllProjects>
      $(MSBuildAllProjects);
      $(SsdtTargetsParentPath)\Microsoft.Data.Tools.Schema.SqlTasks.targets
    </MSBuildAllProjects>
  </PropertyGroup>

  <!--
   Defines default options associated with SQL specific targets
   -->
  <PropertyGroup>
    <CacheTargetModel Condition="'$(CacheTargetModel)' == ''">true</CacheTargetModel>
    <UpdateDatabase  Condition="'$(UpdateDatabase)' == ''">true</UpdateDatabase>
    <GenerateSqlClrDdl Condition="'$(GenerateSqlClrDdl)' == ''">true</GenerateSqlClrDdl>
    <ForceDeployment Condition="'$(ForceDeployment)' == ''">true</ForceDeployment>
    <ValidateCasingOnIdentifiers Condition=" '$(ValidateCasingOnIdentifiers)' == '' ">true</ValidateCasingOnIdentifiers>
    <DefaultSchema Condition=" '$(DefaultSchema)' == '' ">dbo</DefaultSchema>
    <GenerateSqlClrSymbols Condition="'$(GenerateSqlClrSymbols)' == ''">true</GenerateSqlClrSymbols>
  </PropertyGroup>

  <!--
   Defines properties associated with SQL specific targets
   -->
  <PropertyGroup>
    <!-- Required -->
    <SqlTargetName Condition="'$(SqlTargetName)' == ''">$(MSBuildProjectName)</SqlTargetName>
    <SqlTargetFile Condition="'$(SqlTargetFile)' == ''">$(SqlTargetName).dacpac</SqlTargetFile>
    <TargetDatabase Condition="'$(TargetDatabase)' == ''">$(MSBuildProjectName)</TargetDatabase>
    <DeployScriptFileName Condition="'$(DeployScriptFileName)' == ''">$(SqlTargetName).sql</DeployScriptFileName>
    <PublishScriptFileName Condition="'$(PublishScriptFileName)' == ''">$(TargetDatabase).publish.sql</PublishScriptFileName>

    <!-- Fixed -->
    <AssemblyAttributesFile>$(BaseIntermediateOutputPath)\_autogenerated_sqldb$(DefaultLanguageSourceExtension)</AssemblyAttributesFile>
    <CreateScriptFileName>$(SqlTargetName)_Create.sql</CreateScriptFileName>
    <GeneratedFilesIntermediatePath>$(ProjectDir)$(IntermediateOutputPath)</GeneratedFilesIntermediatePath>
    <IntermediateTargetFullFileName>$(GeneratedFilesIntermediatePath)$(TargetFileName)</IntermediateTargetFullFileName>
    <SqlServerVerificationReferencesFile>$(GeneratedFilesIntermediatePath)$(SqlTargetName).VerificationReferences.sql</SqlServerVerificationReferencesFile>

    <!-- Conditional -->
    <IntermediateSymbolsFullFileName Condition="'$(GenerateSqlClrSymbols)'=='true' and '$(_DebugSymbolsProduced)'=='true' and '$(IntermediateSymbolsFullFileName)'==''">$(GeneratedFilesIntermediatePath)$(TargetName).pdb</IntermediateSymbolsFullFileName>

    <CreateScriptFilePath Condition=" '$(CreateScriptFilePath)' == '' ">$(TargetDir)$(CreateScriptFileName)</CreateScriptFilePath>
    <DacFilePath Condition=" '$(DacFilePath)' == '' ">$(TargetDir)$(DacTargetFileName)</DacFilePath>
    <DeployScriptFilePath Condition=" '$(DeployScriptFilePath)' == '' ">$(TargetDir)$(DeployScriptFileName)</DeployScriptFilePath>
    <PublishScriptFilePath Condition=" '$(PublishScriptFilePath)' == '' ">$(TargetDir)$(PublishScriptFileName)</PublishScriptFilePath>
    <SqlTargetPath Condition=" '$(SqlTargetPath)' == '' ">$(TargetDir)$(SqlTargetFile)</SqlTargetPath>
  </PropertyGroup>

  <ItemGroup>
    <IntermediateSymbolsPath Include="$(IntermediateSymbolsFullFileName)" />
    <OutputSymbolsPath Include="@(IntermediateSymbolsPath->'$(TargetDir)%(Filename)%(Extension)')" Condition="'$(_DebugSymbolsProduced)'=='true'"/>
  </ItemGroup>

  <!--
   Define DAC specific properties
   -->
  <PropertyGroup>
    <DacApplicationName Condition="'$(DacApplicationName)' == ''">$(SqlTargetName)</DacApplicationName>
    <DacVersion Condition="'$(DacVersion)' == ''">1.0.0.0</DacVersion>
    <DacDownlevelVersion>.2.0</DacDownlevelVersion>
    <DacTargetExtension>.dacpac</DacTargetExtension>
    <DacTargetFileName>$(SqlTargetName)$(DacDownlevelVersion)$(DacTargetExtension)</DacTargetFileName>
  </PropertyGroup>

  <!--
   Defines items associated with SQL specific targets
   -->
  <ItemGroup>
    <DacFile Include="$(DacFilePath)" />
    <DeployScriptFile Include="$(DeployScriptFilePath)" />
    <PublishScriptFile Include="$(PublishScriptFilePath)" />
    <SqlTarget Include="$(SqlTargetPath)" />
  </ItemGroup>

  <!--
   Target Definition: All
   -->
  <PropertyGroup>
    <AllDependsOn>
      Build;
      Deploy
    </AllDependsOn>
  </PropertyGroup>

  <Target Name="All" DependsOnTargets="$(AllDependsOn)" />

  <!--
   Target Definition: CreateManifestResourceNames

   This overrides an imported target in order to disallow the embedding
   of .resx resources as part of a .sqlproj.
   -->

  <Target Name="CreateManifestResourceNames" />

  <!--===========================================================================-->
  <!-- Build Targets -->
  <!--===========================================================================-->

  <!--
   Target Definition: GetSqlTargetPath
   Dependency Of:     ResolveArtifactReferences

   This stand-alone target returns the path of the sql file produced by the project.
   -->
  <Target Name="GetSqlTargetPath" Returns="$(SqlTargetPath)" />

  <!--
   Target Definition: GetSqlSymbolsPath
   Dependency Of:     ResolveArtifactReferences

   This stand-alone target returns the path of the symbols file produced by the project.
   -->
  <Target Name="GetSqlSymbolsPath" Returns="@(OutputSymbolsPath)" />

  <!--
   Target Definition: ResolveArtifactReferences
   Dependency Of:     Build
                      StaticCodeAnalysis

   Resolve all artifact and resolved project references.
   -->
  <Target Name="ResolveArtifactReferences">

    <PropertyGroup>
      <OnlyReferenceAndBuildProjectsEnabledInSolutionConfiguration Condition="'$(OnlyReferenceAndBuildProjectsEnabledInSolutionConfiguration)' == ''">false</OnlyReferenceAndBuildProjectsEnabledInSolutionConfiguration>
    </PropertyGroup>

    <!-- SQLPROJ: Capture sql project reference and copy locally for privat project references -->
    <MSBuild Condition="'%(Extension)' == '.sqlproj'"
         Projects="@(ProjectReferenceWithConfiguration)"
         Targets="GetTargetPath;GetSqlTargetPath"
         BuildInParallel="$(BuildInParallel)"
         Properties="%(ProjectReferenceWithConfiguration.SetConfiguration);%(ProjectReferenceWithConfiguration.SetPlatform)"
         ContinueOnError="!$(BuildingProject)">
      <Output TaskParameter="TargetOutputs" ItemName="_AllSqlReferenceTargetPath" />
      <Output TaskParameter="TargetOutputs" ItemName="ReferenceCopyLocalPaths" Condition="'%(ProjectReferenceWithConfiguration.Private)' != 'false'" />
    </MSBuild>

    <!-- SQLPROJ: Copy symbols for private project reference -->
    <MSBuild Condition="'%(Extension)' == '.sqlproj' and '%(ProjectReferenceWithConfiguration.Private)' != 'false'"
         Projects="@(ProjectReferenceWithConfiguration)"
         Targets="GetSqlSymbolsPath"
         BuildInParallel="$(BuildInParallel)"
         Properties="%(ProjectReferenceWithConfiguration.SetConfiguration);%(ProjectReferenceWithConfiguration.SetPlatform)"
         ContinueOnError="!$(BuildingProject)">
      <Output TaskParameter="TargetOutputs" ItemName="ReferenceCopyLocalPaths" />
    </MSBuild>

    <!-- *PROJ: Always capture references for anything other than a .sqlproj reference -->
    <MSBuild Condition="'%(Extension)' != '.sqlproj'"
             Projects="@(ProjectReferenceWithConfiguration)"
             Targets="GetTargetPath"
             BuildInParallel="$(BuildInParallel)"
             Properties="%(ProjectReferenceWithConfiguration.SetConfiguration); %(ProjectReferenceWithConfiguration.SetPlatform)"
             ContinueOnError="!$(BuildingProject)">
      <Output TaskParameter="TargetOutputs" ItemName="_AllSqlReferenceTargetPath" />
    </MSBuild>

    <CreateItem Include="@(_AllSqlReferenceTargetPath)" Condition="'@(_AllSqlReferenceTargetPath)'!=''">
      <Output TaskParameter="Include" ItemName="SqlReferencePath" />
    </CreateItem>

    <CreateItem Include="@(ReferencePath)" Condition="'@(ReferencePath)'!=''">
      <Output TaskParameter="Include" ItemName="SqlReferencePath" />
    </CreateItem>

    <CreateItem Include="@(ArtifactReference)" Condition="'@(ArtifactReference)'!=''">
      <Output TaskParameter="Include" ItemName="SqlReferencePath" />
      <Output TaskParameter="Include" ItemName="ReferenceCopyLocalPaths" Condition="'%(ArtifactReference.Private)' != 'false'" />
    </CreateItem>

    <CreateItem Include="@(SqlCmdVariable)" Condition="'@(SqlCmdVariable)'!=''">
      <Output TaskParameter="Include" ItemName="SqlCmdVariables" />
    </CreateItem>

  </Target>

  <!--
   Target Definition: GenerateSqlTargetFrameworkMoniker
   Dependency Of:     Build

   Emit an empty code file into a temporary source file in order to satisfy the compiler.
   -->
  <PropertyGroup>
    <GenerateSqlTargetFrameworkMoniker Condition="'$(GenerateSqlTargetFrameworkMoniker)' == ''">true</GenerateSqlTargetFrameworkMoniker>
    <!-- Clean if GenerateSqlTargetFrameworkMonikerPath is specified... -->
    <GenerateSqlTargetFrameworkMonikerClean Condition="'$(GenerateSqlTargetFrameworkMonikerClean)' == '' and '$(GenerateSqlTargetFrameworkMonikerPath)' != ''">true</GenerateSqlTargetFrameworkMonikerClean>
    <!-- ...otherwise, default the path to the temp directory -->
    <GenerateSqlTargetFrameworkMonikerPath Condition="'$(GenerateSqlTargetFrameworkMonikerPath)' == ''">$([System.IO.Path]::Combine('$([System.IO.Path]::GetTempPath())','$(TargetFrameworkMoniker).SqlClrAttributes$(DefaultLanguageSourceExtension)'))</GenerateSqlTargetFrameworkMonikerPath>
  </PropertyGroup>

  <ItemGroup Condition="'$(GenerateSqlTargetFrameworkMonikerClean)' == 'true'">
    <Clean Include="$(GenerateSqlTargetFrameworkMonikerPath)" />
  </ItemGroup>

  <Target Name="GenerateSqlTargetFrameworkMoniker"
          Condition="'$(GenerateSqlTargetFrameworkMoniker)' == 'true'"
          BeforeTargets="BeforeCompile"
          DependsOnTargets="PrepareForBuild;GetReferenceAssemblyPaths"
          Inputs="$(MSBuildToolsPath)\Microsoft.Common.targets"
          Outputs="$(GenerateSqlTargetFrameworkMonikerPath)">

    <PropertyGroup Condition="'$(TargetLanguage)' == 'CS'">
      <SqlTargetFrameworkMonikerText Condition="'$(SqlTargetFrameworkMonikerText)' == ''">
        // &lt;autogenerated /&gt;
      </SqlTargetFrameworkMonikerText>
    </PropertyGroup>

    <PropertyGroup Condition="'$(TargetLanguage)' == 'VB'">
      <SqlTargetFrameworkMonikerText Condition="'$(SqlTargetFrameworkMonikerText)' == ''">
        ''autogenerated
        Option Strict Off
        Option Explicit On
      </SqlTargetFrameworkMonikerText>
    </PropertyGroup>

    <!--
     This is a file shared between projects so we have to take care to handle simultaneous
     writes (by ContinueOnError) and a race between clean from one project and build from another
     (by not adding to FileWrites so it doesn't clean)
     -->
    <WriteLinesToFile Condition="'$(SqlTargetFrameworkMonikerText)' != ''"
                      ContinueOnError="true"
                      File="$(GenerateSqlTargetFrameworkMonikerPath)"
                      Lines="$(SqlTargetFrameworkMonikerText)"
                      Overwrite="true" />

    <ItemGroup Condition="'$(SqlTargetFrameworkMonikerText)' != ''">
      <!--
       Do not put in FileWrites: this is a file shared between projects in %temp%.
       Cleaning it would create a race between projects during rebuild
       -->
      <Compile Include="$(GenerateSqlTargetFrameworkMonikerPath)" />
    </ItemGroup>

  </Target>

  <!--
   Target Definition: SqlStudioSourceFilesToCopy
   Dependency Of:     GetCopyToOutputDirectoryItems

   Integrate the file types in our project system (Build, None, PostDeploy, PreDeploy)
   with the source files in Microsoft.Common.targets.
   -->
  <PropertyGroup>
    <GetCopyToOutputDirectoryItemsDependsOn>
      $(GetCopyToOutputDirectoryItemsDependsOn);
      SqlStudioSourceFilesToCopy
    </GetCopyToOutputDirectoryItemsDependsOn>
  </PropertyGroup>

  <Target Name="SqlStudioSourceFilesToCopy">

    <CreateItem  Include="@(Build)" Condition="'%(Build.CopyToOutputDirectory)'=='Always' or '%(Build.CopyToOutputDirectory)'=='PreserveNewest'">
      <Output TaskParameter="Include" ItemName="_BuildItemsToCopy" />
    </CreateItem>

    <AssignTargetPath Files="@(_BuildItemsToCopy)" RootFolder="$(MSBuildProjectDirectory)">
      <Output TaskParameter="AssignedFiles" ItemName="_SqlStudioItemsToCopyWithTargetPath" />
    </AssignTargetPath>

    <CreateItem  Include="@(None)" Condition="'%(None.CopyToOutputDirectory)'=='Always' or '%(None.CopyToOutputDirectory)'=='PreserveNewest'">
      <Output TaskParameter="Include" ItemName="_NoneItemsToCopy" />
    </CreateItem>

    <AssignTargetPath Files="@(_NoneItemsToCopy)" RootFolder="$(MSBuildProjectDirectory)">
      <Output TaskParameter="AssignedFiles" ItemName="_SqlStudioItemsToCopyWithTargetPath" />
    </AssignTargetPath>

    <CreateItem Include="@(PreDeploy)" Condition="'%(PreDeploy.CopyToOutputDirectory)'=='Always' or '%(PreDeploy.CopyToOutputDirectory)'=='PreserveNewest'">
      <Output TaskParameter="Include" ItemName="_PreDeployItemsToCopy" />
    </CreateItem>

    <AssignTargetPath Files="@(_PreDeployItemsToCopy)" RootFolder="$(MSBuildProjectDirectory)">
      <Output TaskParameter="AssignedFiles" ItemName="_SqlStudioItemsToCopyWithTargetPath" />
    </AssignTargetPath>

    <AssignTargetPath Files="@(_DataMotionScriptItemsToCopy)" RootFolder="$(MSBuildProjectDirectory)">
      <Output TaskParameter="AssignedFiles" ItemName="_SqlStudioItemsToCopyWithTargetPath" />
    </AssignTargetPath>

    <CreateItem  Include="@(PostDeploy)" Condition="'%(PostDeploy.CopyToOutputDirectory)'=='Always' or '%(PostDeploy.CopyToOutputDirectory)'=='PreserveNewest'">
      <Output TaskParameter="Include" ItemName="_PostDeployItemsToCopy" />
    </CreateItem>

    <AssignTargetPath Files="@(_PostDeployItemsToCopy)" RootFolder="$(MSBuildProjectDirectory)">
      <Output TaskParameter="AssignedFiles" ItemName="_SqlStudioItemsToCopyWithTargetPath" />
    </AssignTargetPath>

    <ItemGroup>
      <AllItemsFullPathWithTargetPath Include="@(_SqlStudioItemsToCopyWithTargetPath->'%(FullPath)')" />
      <_SourceItemsToCopyToOutputDirectoryAlways Include="@(_SqlStudioItemsToCopyWithTargetPath->'%(FullPath)')" Condition="'%(_SqlStudioItemsToCopyWithTargetPath.CopyToOutputDirectory)'=='Always'" />
      <_SourceItemsToCopyToOutputDirectory Include="@(_SqlStudioItemsToCopyWithTargetPath->'%(FullPath)')" Condition="'%(_SqlStudioItemsToCopyWithTargetPath.CopyToOutputDirectory)'=='PreserveNewest'" />
    </ItemGroup>

  </Target>

  <!--
   Target Definition: _SetupSqlBuildInputs.
   Dependency Of:     SqlBuild
   
   Defines the default inputs to the build task as SqlBuildInputItem.  Additional
   inputs to the build task they should be added to SqlBuildInputItem.
   -->
  <Target Name="_SetupSqlBuildInputs" Outputs="@(SqlBuildInputItem)">

    <SqlModelResolutionTask>
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </SqlModelResolutionTask>

    <CreateItem Include="$(MSBuildAllProjects)">
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </CreateItem>

    <CreateItem  Include="@(Build)">
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </CreateItem>

    <CreateItem  Include="$(MSBuildProjectFullPath)">
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </CreateItem>

    <CreateItem  Include="@(SqlReferencePath)">
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </CreateItem>

    <CreateItem  Include="@(SqlCmdVariables)">
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </CreateItem>

    <CreateItem Include="$(MSBuildProjectFullPath).user" Condition="Exists('$(MSBuildProjectFullPath).user')">
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </CreateItem>

    <CreateItem Include="$(IntermediateTargetFullFileName)" Condition="Exists('$(IntermediateTargetFullFileName)')">
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </CreateItem>

    <CreateItem Include="$(IntermediateSymbolsFullFileName)" Condition="Exists('$(IntermediateSymbolsFullFileName)')">
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </CreateItem>

    <CreateItem  Include="@(PostDeploy)">
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </CreateItem>

    <CreateItem  Include="@(PreDeploy)">
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </CreateItem>

    <CreateItem  Include="@(RefactorLog)">
      <Output TaskParameter="Include" ItemName="__SqlBuildInputItem" />
    </CreateItem>

    <SqlScriptDependenciesTask
      PostdeployItem="@(PostDeploy)"
      PredeployItem="@(PreDeploy)"
      SqlCmdVariables="@(SqlCmdVariables)">

      <Output TaskParameter="DependentFiles" ItemName="__SqlBuildInputItem" />
    </SqlScriptDependenciesTask>

    <CreateItem  Include="@(__SqlBuildInputItem->'%(FullPath)')">
      <Output TaskParameter="Include" ItemName="SqlBuildInputItem" />
    </CreateItem>

  </Target>

  <!--
   Target Definition: _SetupSqlBuildOutputs
   Dependency Of:     SqlBuild

   Defines the default outputs of a database build.  Additional outputs
   should be added as SqlBuildOutputItem definitions.
   -->
  <PropertyGroup>
    <!-- Specify targets in order to provide additional outputs -->
    <SetupSqlBuildOutputsDependsOn />
  </PropertyGroup>

  <Target Name="_SetupSqlBuildOutputs"
          Outputs="@(SqlBuildOutputItem)"
          DependsOnTargets="$(SetupSqlBuildOutputsDependsOn)">

    <CreateItem  Include="@(SqlTarget)">
      <Output TaskParameter="Include" ItemName="_SqlBuildOutputItem" />
    </CreateItem>

    <CreateItem  Include="@(DacFile)" Condition="$(GenerateDac) == true">
      <Output TaskParameter="Include" ItemName="_SqlBuildOutputItem" />
    </CreateItem>

    <CreateItem  Include="$(CreateScriptFilePath)" Condition="$(GenerateCreateScript) == true">
      <Output TaskParameter="Include" ItemName="_SqlBuildOutputItem" />
    </CreateItem>

    <CreateItem Include="@(_SqlBuildOutputItem->'%(FullPath)')">
      <Output TaskParameter="Include" ItemName="SqlBuildOutputItem" />
      <Output TaskParameter="Include" ItemName="FileWrites" />
    </CreateItem>

  </Target>


  <!--
   Target Definition: SqlBuild
   Dependency Of:     Build
   -->
  <PropertyGroup>
    <SqlBuildDependsOn>
      _SetupSqlBuildInputs;
      _SetupSqlBuildOutputs;
    </SqlBuildDependsOn>
  </PropertyGroup>

  <Target Name="SqlBuild"
          Inputs="@(SqlBuildInputItem)"
          Outputs="@(SqlBuildOutputItem)"
          DependsOnTargets="$(SqlBuildDependsOn)">

    <SqlBuildTask
      PostdeployItem="@(PostDeploy)"
      PredeployItem="@(PreDeploy)"
      RefactorLog="@(RefactorLog)"
      SqlTarget="@(SqlTarget)"

      BuildExtensionConfiguration="@(BuildExtensionConfiguration)"
      ConnectionString="$(TargetConnectionString)"
      ContributorArguments="@(BuildContributorArgument)"
      CreateScriptFileName="$(CreateScriptFileName)"
      DacApplicationName="$(DacApplicationName)"
      DacDescription="$(DacDescription)"
      DacFile="@(DacFile)"
      DacVersion="$(DacVersion)"
      DatabaseName="$(TargetDatabase)"
      DatabaseSchemaProviderName="$(DSP)"
      DefaultSchema="$(DefaultSchema)"
      DeploymentScriptName="$(DeployScriptFileName)"
      DeployToDatabase="$(UpdateDatabase)"
      GenerateCreateScript="$(GenerateCreateScript)"
      GenerateDac="$(GenerateDac)"
      ImplicitDllAssemblyName="$(AssemblyName)"
      ImplicitDllAssemblyOwner="$(AssemblyOwner)"
      ImplicitDllFileName="$(IntermediateTargetFullFileName)"
      ImplicitDllSymbolsFileName="$(IntermediateSymbolsFullFileName)"
      ImplicitDllGenerateSqlClrDdl="$(GenerateSqlClrDdl)"
      ImplicitDllIsVisible="$(IsVisible)"
      ImplicitDllPermissionSet="$(PermissionSet)"
      IntermediateDirectory="$(GeneratedFilesIntermediatePath)"
      ModelCollation="$(ModelCollation)"
      OutputDirectory="$(TargetDir)"
      PreserveHeaderComments="$(PreserveHeaderComments)"
      Source="@(Build)"
      SqlCmdVariables="@(SqlCmdVariables)"
      SqlReferencePath="@(SqlReferencePath)"
      SqlServerVerification="$(SqlServerVerification)"
      SqlServerVerificationReferencesFile = "$(SqlServerVerificationReferencesFile)"
      SuppressTSqlWarnings="$(SuppressTSqlWarnings)"
      TreatTSqlWarningsAsErrors="$(TreatTSqlWarningsAsErrors)"
      ValidateCasingOnIdentifiers="$(ValidateCasingOnIdentifiers)"
      DefaultCollation="$(DefaultCollation)"
      AnsiNullDefault="$(AnsiNullDefault)"
      AnsiNulls="$(AnsiNulls)"
      AnsiPadding="$(AnsiPadding)"
      AnsiWarnings="$(AnsiWarnings)"
      ArithAbort="$(ArithAbort)"
      ConcatNullYieldsNull="$(ConcatNullYieldsNull)"
      QuotedIdentifier="$(QuotedIdentifier)"
      NumericRoundAbort="$(NumericRoundAbort)"
      RecursiveTriggersEnabled="$(RecursiveTriggersEnabled)"
      DatabaseChaining="$(DatabaseChaining)"
      DatabaseState="$(DatabaseState)"
      UpdateOptions="$(UpdateOptions)"
      CloseCursorOnCommitEnabled="$(CloseCursorOnCommitEnabled)"
      DefaultCursor="$(DefaultCursor)"
      AutoClose="$(AutoClose)"
      AutoCreateStatistics="$(AutoCreateStatistics)"
      AutoShrink="$(AutoShrink)"
      AutoUpdateStatistics="$(AutoUpdateStatistics)"
      TornPageDetection="$(TornPageDetection)"
      DatabaseAccess="$(DatabaseAccess)"
      Recovery="$(Recovery)"
      EnableFullTextSearch="$(EnableFullTextSearch)"
      DefaultFilegroup="$(DefaultFilegroup)"
      Trustworthy="$(Trustworthy)"
      AutoUpdateStatisticsAsynchronously="$(AutoUpdateStatisticsAsynchronously)"
      PageVerify="$(PageVerify)"
      ServiceBrokerOption="$(ServiceBrokerOption)"
      DateCorrelationOptimizationOn="$(DateCorrelationOptimizationOn)"
      Parameterization="$(Parameterization)"
      AllowSnapshotIsolation="$(AllowSnapshotIsolation)"
      ReadCommittedSnapshot="$(ReadCommittedSnapshot)"
      VardecimalStorageFormatOn="$(VardecimalStorageFormatOn)"
      SupplementalLoggingOn="$(SupplementalLoggingOn)"
      CompatibilityMode="$(CompatibilityMode)"
      DefaultFileStreamFilegroup="$(DefaultFileStreamFilegroup)"
      IsChangeTrackingOn="$(IsChangeTrackingOn)"
      IsChangeTrackingAutoCleanupOn="$(IsChangeTrackingAutoCleanupOn)"
      ChangeTrackingRetentionPeriod="$(ChangeTrackingRetentionPeriod)"
      ChangeTrackingRetentionUnit="$(ChangeTrackingRetentionUnit)"
      IsEncryptionOn="$(IsEncryptionOn)"
      IsBrokerPriorityHonored="$(IsBrokerPriorityHonored)"
      Containment="$(Containment)"
      DatabaseDefaultLanguage="$(DatabaseDefaultLanguage)"
      DatabaseDefaultFulltextLanguage="$(DatabaseDefaultFulltextLanguage)"
      IsNestedTriggersOn="$(IsNestedTriggersOn)"
      IsTransformNoiseWordsOn="$(IsTransformNoiseWordsOn)"
      TwoDigitYearCutoff="$(TwoDigitYearCutoff)"
      NonTransactedFileStreamAccess="$(NonTransactedFileStreamAccess)"
      FileStreamDirectoryName="$(FileStreamDirectoryName)"
      TargetRecoveryTimePeriod="$(TargetRecoveryTimePeriod)"
      TargetRecoveryTimeUnit="$(TargetRecoveryTimeUnit)"
      AllowDropBlockingAssemblies="$(AllowDropBlockingAssemblies)"
      AllowIncompatiblePlatform="$(AllowIncompatiblePlatform)"
      BackupDatabaseBeforeChanges="$(BackupDatabaseBeforeChanges)"
      BlockOnPossibleDataLoss="$(BlockOnPossibleDataLoss)"
      BlockWhenDriftDetected="$(BlockWhenDriftDetected)"
      CommentOutSetVarDeclarations="$(CommentOutSetVarDeclarations)"
      CompareUsingTargetCollation="$(CompareUsingTargetCollation)"
      CreateNewDatabase="$(CreateNewDatabase)"
      DeployDatabaseInSingleUserMode="$(DeployDatabaseInSingleUserMode)"
      DisableAndReenableDdlTriggers="$(DisableAndReenableDdlTriggers)"
      DoNotAlterChangeDataCaptureObjects="$(DoNotAlterChangeDataCaptureObjects)"
      DoNotAlterReplicatedObjects="$(DoNotAlterReplicatedObjects)"
      DropConstraintsNotInSource="$(DropConstraintsNotInSource)"
      DropDmlTriggersNotInSource="$(DropDmlTriggersNotInSource)"
      DropExtendedPropertiesNotInSource="$(DropExtendedPropertiesNotInSource)"
      DropIndexesNotInSource="$(DropIndexesNotInSource)"
      DropObjectsNotInSource="$(DropObjectsNotInSource)"
      DropPermissionsNotInSource="$(DropPermissionsNotInSource)"
      DropRoleMembersNotInSource="$(DropRoleMembersNotInSource)"
      GenerateSmartDefaults="$(GenerateSmartDefaults)"
      IgnoreAnsiNulls="$(IgnoreAnsiNulls)"
      IgnoreAuthorizer="$(IgnoreAuthorizer)"
      IgnoreColumnCollation="$(IgnoreColumnCollation)"
      IgnoreComments="$(IgnoreComments)"
      IgnoreCryptographicProviderFilePath="$(IgnoreCryptographicProviderFilePath)"
      IgnoreDdlTriggerOrder="$(IgnoreDdlTriggerOrder)"
      IgnoreDdlTriggerState="$(IgnoreDdlTriggerState)"
      IgnoreDefaultSchema="$(IgnoreDefaultSchema)"
      IgnoreDmlTriggerOrder="$(IgnoreDmlTriggerOrder)"
      IgnoreDmlTriggerState="$(IgnoreDmlTriggerState)"
      IgnoreExtendedProperties="$(IgnoreExtendedProperties)"
      IgnoreFileAndLogFilePath="$(IgnoreFileAndLogFilePath)"
      IgnoreFilegroupPlacement="$(IgnoreFilegroupPlacement)"
      IgnoreFileSize="$(IgnoreFileSize)"
      IgnoreFillFactor="$(IgnoreFillFactor)"
      IgnoreFullTextCatalogFilePath="$(IgnoreFullTextCatalogFilePath)"
      IgnoreIdentitySeed="$(IgnoreIdentitySeed)"
      IgnoreIncrement="$(IgnoreIncrement)"
      IgnoreIndexOptions="$(IgnoreIndexOptions)"
      IgnoreIndexPadding="$(IgnoreIndexPadding)"
      IgnoreKeywordCasing="$(IgnoreKeywordCasing)"
      IgnoreLockHintsOnIndexes="$(IgnoreLockHintsOnIndexes)"
      IgnoreLoginSids="$(IgnoreLoginSids)"
      IgnoreNotForReplication="$(IgnoreNotForReplication)"
      IgnoreObjectPlacementOnPartitionScheme="$(IgnoreObjectPlacementOnPartitionScheme)"
      IgnorePartitionSchemes="$(IgnorePartitionSchemes)"
      IgnorePermissions="$(IgnorePermissions)"
      IgnoreQuotedIdentifiers="$(IgnoreQuotedIdentifiers)"
      IgnoreRoleMembership="$(IgnoreRoleMembership)"
      IgnoreRouteLifetime="$(IgnoreRouteLifetime)"
      IgnoreSemicolonBetweenStatements="$(IgnoreSemicolonBetweenStatements)"
      IgnoreTableOptions="$(IgnoreTableOptions)"
      IgnoreUserSettingsObjects="$(IgnoreUserSettingsObjects)"
      IgnoreWhitespace="$(IgnoreWhitespace)"
      IgnoreWithNocheckOnCheckConstraints="$(IgnoreWithNocheckOnCheckConstraints)"
      IgnoreWithNocheckOnForeignKeys="$(IgnoreWithNocheckOnForeignKeys)"
      IncludeCompositeObjects="$(IncludeCompositeObjects)"
      IncludeTransactionalScripts="$(IncludeTransactionalScripts)"
      NoAlterStatementsToChangeCLRTypes="$(NoAlterStatementsToChangeCLRTypes)"
      PopulateFilesOnFileGroups="$(PopulateFilesOnFileGroups)"
      RegisterDataTierApplication="$(RegisterDataTierApplication)"
      ScriptDatabaseCollation="$(ScriptDatabaseCollation)"
      ScriptDatabaseCompatibility="$(ScriptDatabaseCompatibility)"
      ScriptDatabaseOptions="$(ScriptDatabaseOptions)"
      ScriptDeployStateChecks="$(ScriptDeployStateChecks)"
      ScriptFileSize="$(ScriptFileSize)"
      ScriptNewConstraintValidation="$(ScriptNewConstraintValidation)"
      ScriptRefreshModule="$(ScriptRefreshModule)"
      TargetDatabaseName="$(TargetDatabaseName)"
      TreatVerificationErrorsAsWarnings="$(TreatVerificationErrorsAsWarnings)"
      UnmodifiableObjectWarnings="$(UnmodifiableObjectWarnings)"
      VerifyCollationCompatibility="$(VerifyCollationCompatibility)"
      VerifyDeployment="$(VerifyDeployment)"
      >
      <Output TaskParameter="IntermediateFileWrites" ItemName="FileWrites"/>
    </SqlBuildTask>

  </Target>

  <Target Name="SqlPrepareForRun">
    <Message Importance="High" Text="$(MSBuildProjectName) -&gt; $(SqlTargetPath)" />
  </Target>
  
  <!--
   Target Definition: Build
   Dependency Of:     All
   -->
  <PropertyGroup>
    <BuildDependsOn>
      BuildOnlySettings;
      BeforeBuild;
      PrepareForBuild;
      PreBuildEvent;
      ResolveReferences;
      ResolveArtifactReferences;
      GenerateSqlTargetFrameworkMoniker;
      ResolveKeySource;
      CoreCompile;
      GenerateSerializationAssemblies;
      SqlBuild;
      GetTargetPath;
      PrepareForRun;
      SqlPrepareForRun;
      IncrementalClean;
      PostBuildEvent;
      AfterBuild;
    </BuildDependsOn>
  </PropertyGroup>

  <Target Name="Build" DependsOnTargets="$(BuildDependsOn)">
    <!--
     If the project is unloaded we need to cache the results of all external entry points. Most
     of these targets don't do actual work but we need to make sure that the result of the targets is
     in the cache.
     -->
    <CallTarget Targets="GetCopyToOutputDirectoryItems" UseResultsCache="true" Condition="'$(UnloadProjectsOnCompletion)'=='true'" />
    <CallTarget Targets="GetNativeManifest" UseResultsCache="true" Condition="'$(UnloadProjectsOnCompletion)'=='true'" />
    <CallTarget Targets="GetTargetPath" UseResultsCache="true" Condition="'$(UnloadProjectsOnCompletion)'=='true'" />

    <OnError ExecuteTargets="_TimeStampAfterCompile;PostBuildEvent" Condition="'$(RunPostBuildEvent)'=='Always' or '$(RunPostBuildEvent)'=='OnOutputUpdated'" />
    <OnError ExecuteTargets="_CleanRecordFileWrites" />

  </Target>

  <!--===========================================================================-->
  <!-- Project Output Group Targets -->
  <!--===========================================================================-->

  <!--
   Target Definition: BuiltSqlProjectOutputGroup
   Dependency Of:     AllProjectOutputGroups
   -->
  <PropertyGroup>
    <BuiltSqlProjectOutputGroupDependsOn>
      $(BuiltProjectOutputGroupDependsOn);
      _SetupSqlBuildOutputs
    </BuiltSqlProjectOutputGroupDependsOn>
  </PropertyGroup>

  <Target Name="BuiltSqlProjectOutputGroup"
          Outputs="@(BuiltSqlProjectOutputGroupOutput)"
          DependsOnTargets="$(BuiltSqlProjectOutputGroupDependsOn)">

    <CreateItem Include="@(SqlBuildOutputItem)">
      <Output TaskParameter="Include" ItemName="_BuiltSqlProjectOutputGroupOutputIntermediate" />
    </CreateItem>

    <!-- Convert intermediate items into final items; this way we can get the full path for each item -->
    <CreateItem Include="@(_BuiltSqlProjectOutputGroupOutputIntermediate->'%(FullPath)')">
      <Output TaskParameter="Include" ItemName="BuiltProjectOutputGroupOutput" />
    </CreateItem>

  </Target>

  <!--
   Target Definition: SourceFilesProjectOutputGroup
   Dependency Of:     AllProjectOutputGroups

   Overrides the SourceFilesProjectOutputGroup target.
   -->
  <PropertyGroup>
    <SourceFilesProjectOutputGroupDependsOn>
      $(SourceFilesProjectOutputGroupDependsOn);
      _SetupSqlBuildInputs
    </SourceFilesProjectOutputGroupDependsOn>
  </PropertyGroup>

  <Target Name="SourceFilesProjectOutputGroup"
          Outputs="@(SourceFilesProjectOutputGroupOutput)"
          DependsOnTargets="$(SourceFilesProjectOutputGroupDependsOn)">

    <CreateItem Include="@(__SqlBuildInputItem->'%(FullPath)')">
      <Output TaskParameter="Include" ItemName="AdditionalSourceFile" />
    </CreateItem>

    <AssignTargetPath Files="@(Build)" RootFolder="$(MSBuildProjectDirectory)">
      <Output TaskParameter="AssignedFiles" ItemName="__Source" />
    </AssignTargetPath>

    <AssignTargetPath Files="@(AdditionalSourceFile)"
                RootFolder="$(MSBuildProjectDirectory)"
                Condition="Exists(@(AdditionalSourceFiles))">
      <Output TaskParameter="AssignedFiles" ItemName="__AdditionalSourceFile" />
    </AssignTargetPath>

    <CreateItem Include="@(__Source->'%(FullPath)')">
      <Output TaskParameter="Include" ItemName="SourceFilesProjectOutputGroupOutput" />
    </CreateItem>

    <CreateItem Include="@(__AdditionalSourceFile->'%(FullPath)')" Condition="Exists(@(AdditionalSourceFiles))">
      <Output TaskParameter="Include" ItemName="SourceFilesProjectOutputGroupOutput" />
    </CreateItem>

    <!-- Include the project file -->
    <CreateItem Include="$(MSBuildProjectFullPath)" AdditionalMetadata="TargetPath=$(ProjectFileName)">
      <Output TaskParameter="Include" ItemName="SourceFilesProjectOutputGroupOutput" />
    </CreateItem>

  </Target>

  <!--
   Target Definition: AllProjectOutputGroups

   The targets below drive output groups, which provide generic information about a
   project's inputs (e.g., content files, compilation sources, etc.) and built outputs
   (e.g., built EXE/DLL, PDB, XML documentation files, etc.)

   Each target may produce two kinds of items:  outputs and dependencies.  Outputs are
   items from the current project; dependencies are items that are brought into the
   current project as a result of referencing other projects or components.

   For both outputs and dependencies, the Include attribute
   specifies the location of the output/dependency; it must be a full path.  Any number
   of additional attributes may be placed on an output/dependency item.
   -->
  <PropertyGroup>
    <AllProjectOutputGroupsDependsOn>
      BuiltProjectOutputGroup;
      BuiltSqlProjectOutputGroup;
      DebugSymbolsProjectOutputGroup;
      DocumentationProjectOutputGroup;
      SatelliteDllsProjectOutputGroup;
      SourceFilesProjectOutputGroup;
      ContentFilesProjectOutputGroup;
      SGenFilesOutputGroup;
    </AllProjectOutputGroupsDependsOn>

    <!--
    These groups are defined so the IDE can refresh a particular IVsOutputGroup without having to
    recalculate all other output groups.
    -->
    <AllProjectOutputGroupsDependsOn Condition=" '$(OutputGroupBeingCalculated)' == 'Built' " >
      BuiltProjectOutputGroup;
      BuiltSqlProjectOutputGroup;
    </AllProjectOutputGroupsDependsOn>
    <AllProjectOutputGroupsDependsOn Condition=" '$(OutputGroupBeingCalculated)' == 'ContentFiles' " >
      ContentFilesProjectOutputGroup;
    </AllProjectOutputGroupsDependsOn>
    <AllProjectOutputGroupsDependsOn Condition=" '$(OutputGroupBeingCalculated)' == 'LocalizedResourceDlls' " >
      SatelliteDllsProjectOutputGroup;
    </AllProjectOutputGroupsDependsOn>
    <AllProjectOutputGroupsDependsOn Condition=" '$(OutputGroupBeingCalculated)' == 'Documentation' " >
      DocumentationProjectOutputGroup;
    </AllProjectOutputGroupsDependsOn>
    <AllProjectOutputGroupsDependsOn Condition=" '$(OutputGroupBeingCalculated)' == 'Symbols' " >
      DebugSymbolsProjectOutputGroup;
    </AllProjectOutputGroupsDependsOn>
    <AllProjectOutputGroupsDependsOn Condition=" '$(OutputGroupBeingCalculated)' == 'SourceFiles' " >
      SourceFilesProjectOutputGroup;
    </AllProjectOutputGroupsDependsOn>
    <AllProjectOutputGroupsDependsOn Condition=" '$(OutputGroupBeingCalculated)' == 'XmlSerializer' " >
      SGenFilesOutputGroup;
    </AllProjectOutputGroupsDependsOn>
  </PropertyGroup>

  <Target Name="AllProjectOutputGroups" DependsOnTargets="$(AllProjectOutputGroupsDependsOn)" />


  <!--===========================================================================-->
  <!-- Static Code Analysis (SCA) Targets -->
  <!--===========================================================================-->

  <!--
   Target Definition: SqlStaticCodeAnalysis

   Dependency Of:     StaticCodeAnalysis
   -->
  <Target Name="SqlStaticCodeAnalysis">

    <SqlStaticCodeAnalysisTask CodeAnalysisRules="$(SqlCodeAnalysisRules)"
                               DatabaseSchemaProviderName="$(DSP)"
                               ImplicitDllAssemblyName="$(AssemblyName)"
                               ImplicitDllAssemblyOwner="$(AssemblyOwner)"
                               ImplicitDllFileName="$(IntermediateTargetFullFileName)"
                               ImplicitDllGenerateSqlClrDdl="$(GenerateSqlClrDdl)"
                               ImplicitDllIsVisible="$(IsVisible)"
                               ImplicitDllPermissionSet="$(PermissionSet)"
                               ModelCollation="$(ModelCollation)"
                               ProjectFolder="$(MSBuildProjectDirectory)"
                               ResultsFile="$(ResultsFile)"
                               Source="@(Build)"
                               SqlReferencePath="@(SqlReferencePath)"
                               StaticCodeAnalysisSucceededFile="$(StaticCodeAnalysisSucceededFile)"
                               SuppressTSqlWarnings="$(SuppressTSqlWarnings)"
                               TreatTSqlWarningsAsErrors="$(TreatTSqlWarningsAsErrors)"
                               DefaultCollation="$(DefaultCollation)"
      AnsiNullDefault="$(AnsiNullDefault)"
      AnsiNulls="$(AnsiNulls)"
      AnsiPadding="$(AnsiPadding)"
      AnsiWarnings="$(AnsiWarnings)"
      ArithAbort="$(ArithAbort)"
      ConcatNullYieldsNull="$(ConcatNullYieldsNull)"
      QuotedIdentifier="$(QuotedIdentifier)"
      NumericRoundAbort="$(NumericRoundAbort)"
      RecursiveTriggersEnabled="$(RecursiveTriggersEnabled)"
      DatabaseChaining="$(DatabaseChaining)"
      DatabaseState="$(DatabaseState)"
      UpdateOptions="$(UpdateOptions)"
      CloseCursorOnCommitEnabled="$(CloseCursorOnCommitEnabled)"
      DefaultCursor="$(DefaultCursor)"
      AutoClose="$(AutoClose)"
      AutoCreateStatistics="$(AutoCreateStatistics)"
      AutoShrink="$(AutoShrink)"
      AutoUpdateStatistics="$(AutoUpdateStatistics)"
      TornPageDetection="$(TornPageDetection)"
      DatabaseAccess="$(DatabaseAccess)"
      Recovery="$(Recovery)"
      EnableFullTextSearch="$(EnableFullTextSearch)"
      DefaultFilegroup="$(DefaultFilegroup)"
      Trustworthy="$(Trustworthy)"
      AutoUpdateStatisticsAsynchronously="$(AutoUpdateStatisticsAsynchronously)"
      PageVerify="$(PageVerify)"
      ServiceBrokerOption="$(ServiceBrokerOption)"
      DateCorrelationOptimizationOn="$(DateCorrelationOptimizationOn)"
      Parameterization="$(Parameterization)"
      AllowSnapshotIsolation="$(AllowSnapshotIsolation)"
      ReadCommittedSnapshot="$(ReadCommittedSnapshot)"
      VardecimalStorageFormatOn="$(VardecimalStorageFormatOn)"
      SupplementalLoggingOn="$(SupplementalLoggingOn)"
      CompatibilityMode="$(CompatibilityMode)"
      DefaultFileStreamFilegroup="$(DefaultFileStreamFilegroup)"
      IsChangeTrackingOn="$(IsChangeTrackingOn)"
      IsChangeTrackingAutoCleanupOn="$(IsChangeTrackingAutoCleanupOn)"
      ChangeTrackingRetentionPeriod="$(ChangeTrackingRetentionPeriod)"
      ChangeTrackingRetentionUnit="$(ChangeTrackingRetentionUnit)"
      IsEncryptionOn="$(IsEncryptionOn)"
      IsBrokerPriorityHonored="$(IsBrokerPriorityHonored)"
      Containment="$(Containment)"
      DatabaseDefaultLanguage="$(DatabaseDefaultLanguage)"
      DatabaseDefaultFulltextLanguage="$(DatabaseDefaultFulltextLanguage)"
      IsNestedTriggersOn="$(IsNestedTriggersOn)"
      IsTransformNoiseWordsOn="$(IsTransformNoiseWordsOn)"
      TwoDigitYearCutoff="$(TwoDigitYearCutoff)"
      NonTransactedFileStreamAccess="$(NonTransactedFileStreamAccess)"
      FileStreamDirectoryName="$(FileStreamDirectoryName)"
      TargetRecoveryTimePeriod="$(TargetRecoveryTimePeriod)"
      TargetRecoveryTimeUnit="$(TargetRecoveryTimeUnit)"
                               />

  </Target>

  <!--
   Target Definition: StaticCodeAnalysis
   -->
  <PropertyGroup>
    <ResultsFile Condition=" '$(ResultsFile)' == '' ">$(TargetDir)$(SqlTargetName).StaticCodeAnalysis.Results.xml</ResultsFile>
    <StaticCodeAnalysisSucceededFile Condition=" '$(StaticCodeAnalysisSucceededFile)' == '' ">$(TargetDir)$(SqlTargetName)_StaticCodeAnalysisSucceededFile</StaticCodeAnalysisSucceededFile>
    <StaticCodeAnalysisDependsOn>
      _SetupSqlBuildInputs;
      ResolveReferences;
      ResolveArtifactReferences;
      SqlStaticCodeAnalysis
    </StaticCodeAnalysisDependsOn>
  </PropertyGroup>

  <Target Name="StaticCodeAnalysis" DependsOnTargets="$(StaticCodeAnalysisDependsOn)" />

  <!--
   Target Definition: SqlRunCodeAnalysis
   Dependency Of:     PrepareForRun

   Add SqlRunCodeAnalysis to PrepareForRunDependsOn so that it would be called from Microsoft.Common.Targets
   -->
  <PropertyGroup>
    <PrepareForRunDependsOn>
      $(PrepareForRunDependsOn);
      SqlRunCodeAnalysis
    </PrepareForRunDependsOn>
  </PropertyGroup>

  <!--
   Set our Sql CA property to that of the language property.  Also we set the inputs to FxCopCmd.exe to
   empty so it won't run against our SQL CLR assembly.
   -->
  <PropertyGroup>
    <RunSqlCodeAnalysisOnce Condition="'$(RunCodeAnalysisOnce)' == 'true'">true</RunSqlCodeAnalysisOnce>
    <RunCodeAnalysisInputs></RunCodeAnalysisInputs>
  </PropertyGroup>

  <Target Name="SqlRunCodeAnalysis"
          Condition="'$(RunSqlCodeAnalysis)'=='true' or '$(RunSqlCodeAnalysisOnce)'=='true'"
          Inputs="@(SqlBuildInputItem)"
          Outputs="$(ResultsFile);$(StaticCodeAnalysisSucceededFile)">

    <CallTarget Targets="StaticCodeAnalysis" />

  </Target>

  <!--
   Target Definition: CleanStaticCodeAnalysis
   Dependency Of:     Clean

   Delete code analysis log file and Sql Target file during clean and rebuild.
   -->
  <PropertyGroup>
    <CleanDependsOn>
      $(CleanDependsOn);
      CleanStaticCodeAnalysis;
    </CleanDependsOn>
  </PropertyGroup>

  <Target Name="CleanStaticCodeAnalysis">

    <Delete Files="$(ResultsFile)" />
    <Delete Files="$(StaticCodeAnalysisSucceededFile)" />

  </Target>


  <!--===========================================================================-->
  <!-- Deploy Targets -->
  <!--===========================================================================-->

  <!--
   Target Definition: _SetupSqlDeployInputs
   Dependency Of:     SqlDeploy
-->
  <Target Name="_SetupSqlDeployInputs" Outputs="@(SqlDeployInputItem)">

    <CreateItem Include="@(SqlTarget->'%(FullPath)')">
      <Output TaskParameter="Include" ItemName="SqlDeployInputItem" />
    </CreateItem>

    <CreateItem Condition="'$(ForceDeployment)' == 'true'" Include="ForceScriptRecalculation.txt">
      <Output TaskParameter="Include" ItemName="SqlDeployInputItem" />
    </CreateItem>

  </Target>

  <!--
   Target Definition: _SetupSqlDeployOutputs
   Dependency Of:     SqlDeploy
   -->
  <Target Name="_SetupSqlDeployOutputs" Outputs="@(SqlDeployOutputItem)">

    <CreateItem Include="@(DeployScriptFile->'%(FullPath)')">
      <Output TaskParameter="Include" ItemName="SqlDeployOutputItem" />
    </CreateItem>

  </Target>

  <!--
   Target Definition: SqlDeploy
   Dependency Of:     Deploy
   -->
  <PropertyGroup>
    <SqlDeployDependsOn>
      _SetupSqlDeployInputs;
      _SetupSqlDeployOutputs
    </SqlDeployDependsOn>
  </PropertyGroup>

  <Target Name="SqlDeploy"
          Inputs="@(SqlDeployInputItem)"
          Outputs="@(SqlDeployOutputItem)"
          DependsOnTargets="$(SqlDeployDependsOn)">

    <SqlDeployTask
      CacheTargetModel="$(CacheTargetModel)"
      ConnectionString="$(TargetConnectionString)"
      ContributorArguments="@(DeploymentContributorArgument)"
      DatabaseName="$(TargetDatabase)"
      ScriptFile="@(DeployScriptFile)"
      SourceModel="@(SqlTarget)"
      SqlCommandVariableOverrides="@(SqlCmdVariable)"
      UpdateDatabase="$(UpdateDatabase)"
      AllowDropBlockingAssemblies="$(AllowDropBlockingAssemblies)"
      AllowIncompatiblePlatform="$(AllowIncompatiblePlatform)"
      BackupDatabaseBeforeChanges="$(BackupDatabaseBeforeChanges)"
      BlockOnPossibleDataLoss="$(BlockOnPossibleDataLoss)"
      BlockWhenDriftDetected="$(BlockWhenDriftDetected)"
      CommentOutSetVarDeclarations="$(CommentOutSetVarDeclarations)"
      CompareUsingTargetCollation="$(CompareUsingTargetCollation)"
      CreateNewDatabase="$(CreateNewDatabase)"
      DeployDatabaseInSingleUserMode="$(DeployDatabaseInSingleUserMode)"
      DisableAndReenableDdlTriggers="$(DisableAndReenableDdlTriggers)"
      DoNotAlterChangeDataCaptureObjects="$(DoNotAlterChangeDataCaptureObjects)"
      DoNotAlterReplicatedObjects="$(DoNotAlterReplicatedObjects)"
      DropConstraintsNotInSource="$(DropConstraintsNotInSource)"
      DropDmlTriggersNotInSource="$(DropDmlTriggersNotInSource)"
      DropExtendedPropertiesNotInSource="$(DropExtendedPropertiesNotInSource)"
      DropIndexesNotInSource="$(DropIndexesNotInSource)"
      DropObjectsNotInSource="$(DropObjectsNotInSource)"
      DropPermissionsNotInSource="$(DropPermissionsNotInSource)"
      DropRoleMembersNotInSource="$(DropRoleMembersNotInSource)"
      GenerateSmartDefaults="$(GenerateSmartDefaults)"
      IgnoreAnsiNulls="$(IgnoreAnsiNulls)"
      IgnoreAuthorizer="$(IgnoreAuthorizer)"
      IgnoreColumnCollation="$(IgnoreColumnCollation)"
      IgnoreComments="$(IgnoreComments)"
      IgnoreCryptographicProviderFilePath="$(IgnoreCryptographicProviderFilePath)"
      IgnoreDdlTriggerOrder="$(IgnoreDdlTriggerOrder)"
      IgnoreDdlTriggerState="$(IgnoreDdlTriggerState)"
      IgnoreDefaultSchema="$(IgnoreDefaultSchema)"
      IgnoreDmlTriggerOrder="$(IgnoreDmlTriggerOrder)"
      IgnoreDmlTriggerState="$(IgnoreDmlTriggerState)"
      IgnoreExtendedProperties="$(IgnoreExtendedProperties)"
      IgnoreFileAndLogFilePath="$(IgnoreFileAndLogFilePath)"
      IgnoreFilegroupPlacement="$(IgnoreFilegroupPlacement)"
      IgnoreFileSize="$(IgnoreFileSize)"
      IgnoreFillFactor="$(IgnoreFillFactor)"
      IgnoreFullTextCatalogFilePath="$(IgnoreFullTextCatalogFilePath)"
      IgnoreIdentitySeed="$(IgnoreIdentitySeed)"
      IgnoreIncrement="$(IgnoreIncrement)"
      IgnoreIndexOptions="$(IgnoreIndexOptions)"
      IgnoreIndexPadding="$(IgnoreIndexPadding)"
      IgnoreKeywordCasing="$(IgnoreKeywordCasing)"
      IgnoreLockHintsOnIndexes="$(IgnoreLockHintsOnIndexes)"
      IgnoreLoginSids="$(IgnoreLoginSids)"
      IgnoreNotForReplication="$(IgnoreNotForReplication)"
      IgnoreObjectPlacementOnPartitionScheme="$(IgnoreObjectPlacementOnPartitionScheme)"
      IgnorePartitionSchemes="$(IgnorePartitionSchemes)"
      IgnorePermissions="$(IgnorePermissions)"
      IgnoreQuotedIdentifiers="$(IgnoreQuotedIdentifiers)"
      IgnoreRoleMembership="$(IgnoreRoleMembership)"
      IgnoreRouteLifetime="$(IgnoreRouteLifetime)"
      IgnoreSemicolonBetweenStatements="$(IgnoreSemicolonBetweenStatements)"
      IgnoreTableOptions="$(IgnoreTableOptions)"
      IgnoreUserSettingsObjects="$(IgnoreUserSettingsObjects)"
      IgnoreWhitespace="$(IgnoreWhitespace)"
      IgnoreWithNocheckOnCheckConstraints="$(IgnoreWithNocheckOnCheckConstraints)"
      IgnoreWithNocheckOnForeignKeys="$(IgnoreWithNocheckOnForeignKeys)"
      IncludeCompositeObjects="$(IncludeCompositeObjects)"
      IncludeTransactionalScripts="$(IncludeTransactionalScripts)"
      NoAlterStatementsToChangeCLRTypes="$(NoAlterStatementsToChangeCLRTypes)"
      PopulateFilesOnFileGroups="$(PopulateFilesOnFileGroups)"
      RegisterDataTierApplication="$(RegisterDataTierApplication)"
      ScriptDatabaseCollation="$(ScriptDatabaseCollation)"
      ScriptDatabaseCompatibility="$(ScriptDatabaseCompatibility)"
      ScriptDatabaseOptions="$(ScriptDatabaseOptions)"
      ScriptDeployStateChecks="$(ScriptDeployStateChecks)"
      ScriptFileSize="$(ScriptFileSize)"
      ScriptNewConstraintValidation="$(ScriptNewConstraintValidation)"
      ScriptRefreshModule="$(ScriptRefreshModule)"
      TargetDatabaseName="$(TargetDatabaseName)"
      TreatVerificationErrorsAsWarnings="$(TreatVerificationErrorsAsWarnings)"
      UnmodifiableObjectWarnings="$(UnmodifiableObjectWarnings)"
      VerifyCollationCompatibility="$(VerifyCollationCompatibility)"
      VerifyDeployment="$(VerifyDeployment)"
      />

  </Target>

  <!--
   Target Definition: BeforeDeploy
   Dependency Of:     Deploy
   -->
  <Target Name="BeforeDeploy" />

  <!--
   Target Definition: AfterDeploy
   Dependency Of:     Deploy
   -->
  <Target Name="AfterDeploy" />

  <!--
   Target Definition: PreDeployEvent
   Dependency Of:     Deploy
   -->
  <Target Name="PreDeployEvent"
          Condition="'$(PreDeployEvent)'!='' And Exists($(TargetDir))">

    <Exec WorkingDirectory="$(TargetDir)" Command="$(PreDeployEvent)" />

  </Target>

  <!--
   Target Definition: PostDeployEvent
   Dependency Of:     Deploy
   -->
  <Target Name="PostDeployEvent"
          Condition="'$(PostDeployEvent)'!='' And Exists($(TargetDir))">

    <Exec WorkingDirectory="$(TargetDir)" Command="$(PostDeployEvent)" />

  </Target>

  <!--
   Target Definition: Deploy
   Dependency Of:     All
   -->
  <PropertyGroup>
    <DeployDependsOn>
      BeforeDeploy;
      PreDeployEvent;
      SqlDeploy;
      PostDeployEvent;
      AfterDeploy
    </DeployDependsOn>
  </PropertyGroup>

  <Target Name="Deploy" DependsOnTargets="$(DeployDependsOn)">

    <OnError ExecuteTargets="PostDeployEvent" Condition="'$(RunPostDeployEvent)'=='Always'" />

  </Target>


  <!--===========================================================================-->
  <!-- Publish Targets -->
  <!--===========================================================================-->

  <!--
   Target Definition: _SetupSqlPublishInputs
   Dependency Of:     SqlPublish
-->
  <Target Name="_SetupSqlPublishInputs" Outputs="@(SqlPublishInputItem)">

    <CreateItem  Include="@(SqlTarget)">
      <Output TaskParameter="Include" ItemName="__SqlPublishInputItem" />
    </CreateItem>

    <CreateItem  Include="$(SqlPublishProfilePath)" Condition="'$(SqlPublishProfilePath)' != ''">
      <Output TaskParameter="Include" ItemName="__SqlPublishInputItem" />
    </CreateItem>

    <CreateItem Include="@(__SqlPublishInputItem->'%(FullPath)')">
      <Output TaskParameter="Include" ItemName="SqlPublishInputItem" />
    </CreateItem>

    <CreateItem Condition="'$(ForceDeployment)' == 'true'" Include="ForceScriptRecalculation.txt">
      <Output TaskParameter="Include" ItemName="SqlPublishInputItem" />
    </CreateItem>

  </Target>

  <!--
   Target Definition: _SetupSqlPublishOutputs
   Dependency Of:     SqlPublish
   -->
  <Target Name="_SetupSqlPublishOutputs" Outputs="@(SqlPublishOutputItem)">

    <CreateItem Include="@(PublishScriptFile->'%(FullPath)')">
      <Output TaskParameter="Include" ItemName="SqlPublishOutputItem" />
    </CreateItem>

  </Target>

  <!--
   Target Definition: SqlPublish
   Dependency Of:     Publish
   -->
  <PropertyGroup>
    <SqlPublishDependsOn>
      _SetupSqlPublishInputs;
      _SetupSqlPublishOutputs
    </SqlPublishDependsOn>
  </PropertyGroup>

  <Target Name="SqlPublish"
          Inputs="@(SqlPublishInputItem)"
          Outputs="@(SqlPublishOutputItem)"
          DependsOnTargets="$(SqlPublishDependsOn)">

    <SqlPublishTask
      CacheTargetModel="$(CacheTargetModel)"
      ContributorArguments="@(DeploymentContributorArgument)"
      PublishProfile="$(SqlPublishProfilePath)"
      ScriptFile="@(PublishScriptFile)"
      SourceModel="@(SqlTarget)"
      UpdateDatabase="$(UpdateDatabase)" />

  </Target>

  <!--
   Target Definition: BeforePublish
   Dependency Of:     Publish
   -->
  <Target Name="BeforePublish" />

  <!--
   Target Definition: AfterPublish
   Dependency Of:     Publish
   -->
  <Target Name="AfterPublish" />

  <!--
   Target Definition: PrePublishEvent
   Dependency Of:     Publish
   -->
  <Target Name="PrePublishEvent"
          Condition="'$(PrePublishEvent)'!='' And Exists($(TargetDir))">

    <Exec WorkingDirectory="$(TargetDir)" Command="$(PrePublishEvent)" />

  </Target>

  <!--
   Target Definition: PostPublishEvent
   Dependency Of:     Publish
   -->
  <Target Name="PostPublishEvent"
          Condition="'$(PostPublishEvent)'!='' And Exists($(TargetDir))">

    <Exec WorkingDirectory="$(TargetDir)" Command="$(PostPublishEvent)" />

  </Target>

  <!--
   Target Definition: Publish
   -->
  <PropertyGroup>
    <PublishDependsOn>
      BeforePublish;
      PrePublishEvent;
      SqlPublish;
      PostPublishEvent;
      AfterPublish
    </PublishDependsOn>
  </PropertyGroup>

  <Target Name="Publish" DependsOnTargets="$(PublishDependsOn)">

    <OnError ExecuteTargets="PostPublishEvent" Condition="'$(RunPostPublishEvent)'=='Always'" />

  </Target>

</Project>
